services:
  # Core Service
  nginx:
    container_name: nginx
    build: ./.docker/nginx
    restart: always
    ports:
      - 80:80
      - 443:443
    volumes:
      - .:/var/www/${DOCKER_WORKDIR}
      - ./.docker/nginx/conf.d:/etc/nginx/conf.d
      - ./.docker/logs/nginx:/var/log/nginx
      - ./.docker/nginx/certs:/etc/nginx/certs
    environment:
      WORKDIR: ${DOCKER_WORKDIR}
      APP_HOST: ${APP_HOST}
      API_HOST: ${API_HOST}
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      internet:
        aliases:
          - core.local
          - api.core.local
          - admin.core.local

  php:
    container_name: php
    build:
      context: ./.docker/php
      args:
        HOST_UID: ${HOST_UID}
        USER_NAME: ${DOCKER_PROJECT_NAME}
        TZ: ${DOCKER_TIMEZONE}
    working_dir: /var/www/${DOCKER_WORKDIR}
    restart: unless-stopped
    ports:
      - 9000:9000
    volumes:
      - .:/var/www/${DOCKER_WORKDIR}
      - ./.docker/php/conf.d/xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
      - ./.docker/php/conf.d/opcache.ini:/usr/local/etc/php/conf.d/opcache.ini
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      TZ: ${DOCKER_TIMEZONE}
      PHP_MEMORY_LIMIT: "4096M"
      XDEBUG_ENABLED: ${DOCKER_XDEBUG:-off}
      XDEBUG_CONFIG: "client_host=${DOCKER_XDEBUG_REMOTE_HOST:-host.docker.internal}"
      PHP_IDE_CONFIG: "serverName=${DOCKER_PHP_IDE_CONFIG}"
    networks:
      - internet

  mysql:
    container_name: mysql
    image: mysql:8.4.3
    environment:
      TZ: ${DOCKER_TIMEZONE}
      MYSQL_ROOT_PASSWORD: ${DOCKER_DB_PASSWORD}
      MYSQL_DATABASE: ${DOCKER_DB_NAME}
    ports:
      - 3306:3306
    volumes:
      - ./.docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf
      - ./.docker/logs/mysql:/var/log/mysql/
      - ./.docker/mysql/data:/var/lib/mysql
    healthcheck:
      test: mysqladmin ping -h 127.0.0.1 -u root --password=$$MYSQL_ROOT_PASSWORD
      interval: 5s
      retries: 10
    networks:
      - internet


  redis:
    image: redis:latest
    container_name: redis
    ports:
      - 6379:6379
    volumes:
      - ./.docker/redis/data:/var/lib/redis
      - ./.docker/logs/redis:/var/log/redis/
    environment:
      TZ: ${DOCKER_TIMEZONE}
    networks:
      - internet

  # Scheduler Service
  scheduler:
    image: mcuadros/ofelia:latest
    container_name: scheduler
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./.docker/scheduler/config.ini:/etc/ofelia/config.ini
    depends_on:
      - php

networks:
  internet:
    name: internet